---

copyright:
  years: 2016, 2017
lastupdated: "2017-4-4"
---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:screen:.screen}
{:codeblock:.codeblock}


# Delivery Pipeline について
{: #deliverypipeline_about}

IBM&reg; Bluemix&reg; {{site.data.keyword.deliverypipeline}} サービス (パイプライン) は、Bluemix プロジェクトの継続的なデプロイメントを自動化します。パイプラインでは、一連のステージにより入力内容を取得して、
ビルド、テスト、およびデプロイメントなどのジョブを実行します。
{:shortdesc}

以降のセクションでは、パイプラインの背景にある概念的な詳細を説明します。

## ステージ
{: #deliverypipeline_stages}

ステージは、コードのビルド、デプロイ、およびテスト時に、入力内容とジョブを編成します。ステージは、ソース制御リポジトリー (SCM リポジトリー) からの入力か、他のステージのビルド・ジョブ (ビルド成果物) からの入力を受け入れます。最初のステージを作成するときに、**「入力」**タブにデフォルト設定がセットされます。

ステージの入力内容は、そのステージに含まれるジョブに渡され、各ジョブには、ジョブの実行場所となるクリーンなコンテナーが与えられます。ステージ内のジョブ間で相互に成果物を渡すことはできません。

すべてのジョブで使用可能なステージ環境プロパティーを定義することができます。例えば、単一のステージでジョブをデプロイおよびテス
トするための単一の URL を渡す `TEST_URL` プロパティーを定義することができます。デプロイ・ジョブは、その URL にデプロイし、テスト・ジョブは、URL で実行中のアプリをテストします。

ステージにおいてデフォルトでは、変更がプロジェクトの SCM リポジトリーに送信されるたびに、ビルドとデプロイメントは自動的に実行されます。ステージとジョブは順次実行され、作業のフロー制御を可能にします。例えば、デプロイメント・ステージの前にテスト・ステージを配置すること
ができます。テスト・ステージでテストが失敗すると、デプロイメント・ステージは実行されません。

特定のステージの制御を厳しくすることができます。入力時に変更が発生するたびにステージが実行されないようにするには、機能を無効にすることができます。**「入力」**タブの「ステージ・トリガー」セクションで、**「このステージが手動で実行されたときにのみジョブを実行」**をクリックします。

![「入力」タブ](images/input_tab_only_execute.png)

## ジョブ
{: #deliverypipeline_jobs}

ジョブは、ステージ内の実行単位です。ステージには複数のジョブを含めることができ、ステージ内のジョブは順次実行されます。デフォルトでは、ジョブが失敗すると、ステージ内の以降のジョブは実行されません。

![ステージ内のビルド・ジョブとテスト・ジョブ](images/jobs.png)

ジョブは、各パイプラインの実行用に作成された Docker コンテナー内にある、個別の作業ディレクトリーで実行されます。ジョブが実行される前に、ステージ・レベルで定義された入力データがその作業ディレクトリーに取り込まれます。例えば、テスト・ジョブとデプロイ・ジョブを含むステージがあるとします。1 つのジョブで依存関係をインストールすると、その依存関係はもう一方のジョブ
では使用できません。ただし、ステージの入力で依存関係を使用可能にすると、どちらのジョブでも使用可能となります。

単純タイプのビルド・ジョブを除き、ジョブを構成する際は、ビルド・コマンド、テスト・コマンド、またはデプロイメントの各コマンドを含む UNIX シェル・スクリプトを含めることができます。ジョブは暫定のコンテナーで実行されるため、複数のジョブが同じステージ
の一部である場合でも、1 つのジョブのアクションが他のジョブの実行環境に影響を与えることはできません。

さらに、パイプライン・ジョブは、`sudo` として次のコマンドのみを実行できます。
  * `/usr/sbin/service`
  * `/usr/bin/apt-get`
  * `/usr/bin/apt-key`
  * `/usr/bin/dpkg`
  * `/usr/bin/add-apt-repository`
  * `/opt/IBM/node-v0.10.40-linux-x64/npm`
  * `/opt/IBM/node-v0.12.7-linux-x64/npm`
  * `/opt/IBM/node-v4.2.2-linux-x64/npm`
  * `/usr/bin/Xvfb`
  * `/usr/bin/pip`


ジョブの実行後、そのジョブ用に作成されたコンテナーは破棄されます。ジョブの実行結果は永続できますが、実行環境は永続しません。

**注**: ジョブは最大で 60 分実行することができます。その限界を超えると、ジョブは失敗します。ジョブが限界を超える場合は、複数の
ジョブに分割してください。例えば、1 つのジョブが 3 つのタスクを実行する場合、1 つのタスクが 1 つのジョブとなるように、そのジョブを 3 つのジョブに分割することができます。

ジョブをステージに追加する方法については、[ジョブのステージへの追加](/docs/services/ContinuousDelivery/pipeline_build_deploy.html#deliverypipeline_add_job){: new_window}を参照してください。

### ビルド・ジョブ

ビルド・ジョブは、デプロイメントに備えてプロジェクトをコンパイルします。ビルド・ジョブは、ビルド・アーカイブ・ディレクトリーに送信することができる成果物を生成しますが、デフォルトで成果物はプロジェクトのルート・ディレクトリーに配置されます。

ビルド・ジョブからの入力データを取得するジョブは、ジョブが作成されたのと同じ構造のビルド成果物を参照する必要があります。例えば、ビルド・ジョブがビルド成果物を `output` ディレクトリーにアーカイブする場合、デプロイ・スクリプトは、プロジェクトのルート・ディレク
トリーではなく `output` ディレクトリーを参照して、コンパイルされたプロジェクトをデプロイします。**「ビルド・アーカイブ・ディレクトリー」**フィールドにディレクトリー名を入力することにより、アーカイブするディレクトリーを指定できます。このフィールドをブランクにしておくと、ルート・ディレクトリーにアーカイブされます。

**注**: ビルド・ジョブのビルダー・タイプに**「単純」**を選択すると、ビルド・プロセスをスキップすることになります。この場合、コードはコンパイルされませんが、そのままデプ
ロイメント・ステージへ送信されます。ビルドとデプロイの両方を行うには、**「単純」**以外のビルダー・タイプを選択してください。

#### ビルド・スクリプトの環境プロパティー
ビルド・ジョブのビルド・シェル・コマンド内に環境プロパティーを含めることができます。このプロパティーは、ジョブの実行環境に関する情報へのアクセスを
提供します。 [{{site.data.keyword.deliverypipeline}} サービスの環境プロパティーとリソース](/docs/services/ContinuousDelivery/pipeline_deploy_var.html)を参照してください。

### デプロイ・ジョブ

デプロイ・ジョブは、プロジェクトをアプリとして Bluemix にアップロードし、URL からアクセス可能です。プロジェクトのデプロイ後は、デプロイされたアプリを Bluemix ダッシュボードで検索することができます。

デプロイ・ジョブは、新規アプリをデプロイすることも、既存アプリを更新することもできます。Cloud Foundry コマンド・ライン・インターフェースや Web IDE の実行バーなどの別の方法で最初にアプリをデプロイしていても、デプロイ・ジョブを使用してアプリを更新することができます。デプロイ・ジョブでアプリを更新するには、アプリの名前を使用します。

1 つ以上の地域やサービスにデプロイできます。例えば、1 つ以上のサービスを使用して、1 つの地域でテストし、複数の地域で実動にデプロイするよう {{site.data.keyword.deliverypipeline}} をセットアップできます。詳しくは、[地域](/docs/overview/whatisbluemix.html#ov_intro_reg){: new_window}を参照してください。

#### デプロイメント・スクリプトの環境プロパティー

デプロイ・ジョブのデプロイメント・スクリプト内に環境プロパティーを含めることができます。これらのプロパティーは、ジョブの実行環境に関する情報へのアク
セスを提供します。 [{{site.data.keyword.deliverypipeline}} サービスの環境プロパティーとリソース](/docs/services/ContinuousDelivery/pipeline_deploy_var.html)を参照してください。

### テスト・ジョブ
条件を満たすことが必要な場合は、ビルド・ジョブおよびデプロイ・ジョブの前または後にテスト・ジョブを組み込みます。必要に応じて、テスト・ジョブを単純タイプまた
は複雑タイプにカスタマイズすることができます。例えば、cURL コマンドを実行して特定の応答を予期することができます。また、一連の単体テストを実行したり、Sauce Labs などサード・パーティーのテスト・サービスを使用して機能テストを実行したりすることもできます。

テストの結果ファイルが JUnit XML 形式の場合、結果ファイルに基づいたレポートが各テスト結果ページの**「テスト」**タブに表示されます。テストが不合格の場合は、ジョブも失敗します。

#### テスト・スクリプトの環境プロパティー

テスト・ジョブのスクリプトに環境プロパティーを含めることができます。このプロパティーは、ジョブの実行環境に関する情報へのアクセスを提供します。 [{{site.data.keyword.deliverypipeline}} サービスの環境プロパティーとリソース](/docs/services/ContinuousDelivery/pipeline_deploy_var.html)を参照してください。

## マニフェスト・ファイル
{: #deliverypipeline_manifest}

マニフェスト・ファイルは、`manifest.yml` という名前でプロジェクトのルート・ディレクトリーに格納されます。このファイルは、プロジェクトの Bluemix へのデプロイ方法を制御します。プロジェクト用のマニフェスト・ファイルの作成について詳しくは、[アプリケーション・マニフェストに関する Bluemix の資料](/docs/manageapps/depapps.html#appmanifest)を参照してください。プロジェクトを Bluemix と統合するには、そのプロジェクトのルート
・ディレクトリーにマニフェスト・ファイルが必要です。ただし、そのファイルの情報に基づいてデプロイする必要はありません。

パイプラインでは、`cf push` コマンド引数を使用して、マニフェスト・ファイルで指定可能なすべての設定を指定できます。`cf push` コマンド引数は、複数のデプロイメント・ターゲットがあるプロジェクトで有用です。複数のデプロイ・ジョブがすべてプロジェクト・マニフェスト・ファイルで指定されるルートを使用しようとすると、競合が発生します。

競合を避けるには、`cf push`、続けてホスト名引数、`-n`、およびルート名を使用して、ルートを指定することができます。個々のステージでデプロイメント・スクリプトを変更することにより、複数のターゲットにデプロイする際のルートの競合を回避できます。

`cf push` コマンド引数を使用するには、デプロイ・ジョブの構成設定を開き、**「デプロイ・スクリプト」**フィールドを変更します。詳しくは、[Cloud Foundry Push 資料![外部リンク・アイコン](../../icons/launch-glyph.svg "外部リンク・アイコン")](http://docs.cloudfoundry.org/devguide/installcf/whats-new-v6.html#push){: new_window}を参照してください。

## サンプル・パイプライン
{: #deliverypipeline_example}

サンプル・パイプラインには次の 3 つのステージを含めることができます。

1. アプリのビルド・プロセスをコンパイルして実行するビルド・ステージ。
2. アプリのインスタンスをデプロイして、インスタンス上でテストを実行するテスト・ステージ。
3. テスト済みのアプリの実動インスタンスをデプロイする実動ステージ。

次の概念図に、このパイプラインを示しています。

![パイプラインのステージとジョブの概念図](images/diagram.jpg)

*3 ステージのパイプラインの概念モデル*

各ステージは、その入力データをリポジトリーとビルド・ジョブから取り出し、ステージ内のジョブは、互いに独立して順次実行されます。サンプル・パイプラインでは、テスト・ステージと実動ステージの両方がその入力データとしてビルド・ステージの出力を使用する場合でも、ステージは順次実行されます。
